---
title: "Size-Based Indicator Analysis"
author: "Kevin M. Purcell"
date: "Tuesday, November 18, 2014"
output: html_document
---

## Objectives
Identify and calculate size-based indicator (SBI) time series for the Gulf of Mexico based on the length-frequency data collected by [SEAMAP]() for our focal species.  Indicatory identification is derived from two primary sources [Shin et al. 2005](http://icesjms.oxfordjournals.org/content/62/3/384) and [Rochet and Trinkle 2003](http://www.nrcresearchpress.com/doi/abs/10.1139/f02-164).  Initially a global time series will be developed for community-wide metrics of mean length:

$ \bar{L}=\frac{\sum\limits_{N}L}{N} $  

Additionally, a community estimate of mean weight:

$ \bar{W}=\frac{B}{N} $  

will also be generated and trends over the survey period will be assessed.




## Methods

1. Bring in size frequency and supporting data
```{r dataImport, echo=FALSE}
#library(magrittr)
library(dplyr)
#Import Size frequency table from SEAMAP_2013 DB
#sfDat <- read.csv("C:/Users/Kevin.Purcell/Documents/seamap_2013/GLFREC.csv", 
#                    header = TRUE, sep = ",")
sfDat <- read.csv("C:/Users/Kevin.Purcell/Documents/seamap_2013/GLFREC2.csv", 
                    header = TRUE, sep = ",")
sfDat$meas_typ <- sfDat$MEASCD_GLF


sfDat$meas_typ[sfDat$meas_typ==1] <- "FL"
sfDat$meas_typ[sfDat$meas_typ==2] <- "SL"
sfDat$meas_typ[sfDat$meas_typ==3] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==4] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==5] <- "WD"
sfDat$meas_typ[sfDat$meas_typ==6] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==8] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==10] <- "WD"
sfDat$meas_typ[sfDat$meas_typ==11] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==12] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==13] <- "ML"
sfDat$meas_typ[sfDat$meas_typ==14] <- "WD"
sfDat$meas_typ[sfDat$meas_typ==15] <- "TRD"
sfDat$meas_typ[sfDat$meas_typ==16] <- "WD"
sfDat$meas_typ[sfDat$meas_typ==17] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==18] <- "TL"
sfDat$meas_typ[sfDat$meas_typ==19] <- "UNKNOWN"
sfDat$meas_typ[sfDat$meas_typ==20] <- "OTHER"
sfDat$meas_typ[sfDat$meas_typ==22] <- "WD"
sfDat$meas_typ[sfDat$meas_typ==23] <- "SA"


#Import station table from SEAMAP_2013 DB
stDat <- read.csv("C:/Users/Kevin.Purcell/Documents/seamap_2013/STAREC.csv", 
                    header = TRUE, sep = ",")

#create a yr and month variable
stDat$date<-stDat$MO_DAY_YR
stDat$date<-as.Date(stDat$date, "%m/%d/%Y")
stDat$month<-format(stDat$date, format="%m")
stDat$YR<-format(stDat$date, format="%Y")
stDat$YR<-as.numeric(stDat$YR)
stDat$month<-as.numeric(stDat$month)

#Import the Taxonomy data from SEAMAP_2013 DB
taxDat <- read.csv("C:/Users/Kevin.Purcell/Documents/seamap_2013/NEWBIOCODESBIG.csv", header = TRUE, sep = ",")
```


```{r sfTable, echo=FALSE, results='asis', warning=FALSE, error=FALSE, message=FALSE}

# shortnames=names(sfDat)
# #create variable descriptions
# description <- c("unique integer (int) entry id",
#                  "unique int for ea. entry in CRUSIES table",
#                  "Unique int for ea. entry in BGSREC table",
#                  "unique int for ea. entry in STAREC table",
#                  "unique int for ea. entry in VESSELS table",
#                  "four character (ch.) string format YYXX",
#                  "five ch. string for Pascagoula Station No.",
#                  "9 digit field for Genus species biocode",
#                  "no current used",
#                  "7 ch. field for Genus",
#                  "6 ch. field for species",
#                  "4 digit XXX.X field for weight (kg)",
#                  "2 ch. field containing measurement code",
#                  "4 ch. field (numeric) of length (mm)",
#                  "1 ch. field representing sex (M, F, U) can be blank",
#                  "1 ch. field representing maturity code")
# 
# metadataBound <- cbind(shortnames, description)
# colnames(metadataBound) <- c("Parameter", "Description")
# metadataTable <- xtable::xtable(metadataBound, 
#                                 align="lll",
#                                 caption="Data variables and description") 
# Metadata <- xtable::print.xtable(metadataTable, type="html", comment=FALSE)
```


2. Attached locations or sampling sites to size based data
```{r}
sbiDat1 <- dplyr::inner_join(sfDat, stDat, by = "STATIONID", copy = FALSE)

```


3. Limit the dataset based on the 64 species used in the study
```{r}
#Import list of study species
studySpecies<-read.csv("C:/Users/kevin.purcell/Documents/comm_analysis/seamap_keepers_comm_analysis.csv")
#studySpecies$keep <- NULL
colnames(studySpecies)[1] <- "BIO_GLF"

#return all rows from x where there are matching values in y, keeping just columns from x. 
sbiDat2 <- dplyr::inner_join(sbiDat1, studySpecies, by = NULL, copy = FALSE)
```

4. Attach taxonomic info to the database
```{r}
#change the column name in taxDat to BIO_GLF
colnames(taxDat)[3] <- "BIO_GLF"

#join taxonomy data to database
sbiDat3 <- dplyr::inner_join(sbiDat2, taxDat, by = NULL, copy = FALSE)

# #Isolate the biocodes
# tsnDat <- unique(sbiDat3$tsn)
# #Pull taxonmic data from ITIS???
# taxInfo <- taxize::classification(tsnDat, db = 'itis')
```


6. Calculate the global community Mean length metric by year for TL
```{r}
#length by year
#sum by yeara
#generate mean length by year
df1 <- sbiDat3[c(67,17,14)] 
df2 <- subset(df1, df1$meas_typ=="TL")
mean_len <- aggregate(LEN_GLF ~ YR, data=df2, mean)
colnames(mean_len)[2] <- "meanLen"
sd_len <- aggregate(LEN_GLF ~ YR, data=df2, sd)
colnames(sd_len)[2] <- "sd"
mean_len <- merge(mean_len, sd_len, by="YR")
ggplot2::qplot(YR, meanLen, data=mean_len) +
  geom_point()
, geom=c("point", "smooth"))

ggplot2::ggplot(mean_len, aes(x=YR, y=meanLen)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin=meanLen-sd, ymax=meanLen+sd), width=.1)
   
# Mean weight calculation
#df3 <- sbiDat3[c(67,12)]
#mean_wt <- aggregate(INDVL_WT ~ YR, data=df3, mean)
#%%%%%%%%%%%%%%%% NOT POSSIBLE DUE TO NAs %%%%%%%%%%%%%%%%%%%%%%#

```



3. Derive size based indicators from initial size sampling data
```{r}
meanLen <- sum()


```




4. Evaluate temporal patterns of indicators


