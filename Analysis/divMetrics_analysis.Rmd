Diversity Metrics Analysis Script
=================================

**K.M.Purcell**
[email](mailto:kevin@kevin-purcell.com)


```{r prep, echo=FALSE,warning=FALSE,message=FALSE}
#load packages
library(reshape)
library(lattice)
library(MASS)
library(vegan)
library(doBy)
library(gplots)
library(segmented)
library(pander)
library(knitcitations)
```


```{r dataImport, echo=FALSE, warning=FALSE, message=FALSE}
source("C:\Users\Kevin.Purcell\Documents\GitHub\EcosysMetricsGOM\Data\GatherSource\importDiversityData.R")
```

## Data
### Fishery-independent

The datasets for this analysis derive from both fishery-dependent and fishery-indepedent data sets.  The fishery-independent data was derived from the SEAMAP survey data.  Data was downloaded on 2013-7-3, from the Gulf States Marine Fisheries online SEAMAP [access](http://seamap.gsmfc.org/) website.  We used several tables from their Access database with parameters including:


```{r}
names(starec.dat)
names(envrec.dat)
names(invrec.dat)
names(bgsrec.dat)
```

### Fishery-dependent
Data on fishery-dependent parameters (fishery effort) was derived from data from the SHRCOM databases, which I obtained via [Jim Nance](email:james.m.nance@noaa.gov) from the [Galveston Laboratory](http://www.galvestonlab.sefsc.noaa.gov/) of the [Southeast Fishery Science Center (SEFC)](http://www.sefsc.noaa.gov/).  Data from the fishery was in a aggregated format which was provided directly from Jim with the parameters:

```{r}
names(shrcom.agg)
```

Additionally, I utilized information obtained online from [Fishbase](http://www.fishbase.org/) for species description information, namely habitat characteristics vital to catagorizing species into groups.

```{r}
names(specinfo.dat)
```

The environmental drivers under consideration in this project were fishing effort, data obtained via the ```shrcom.agg``` above and coastal hypoxia.  The hypoxia data was obtained from Rabalais (XXXX)?  I did not update these values to reflect the new study ```citep("10.1021/es400983g").  

```{r}
summary(hypox.area)
```


```{r dataMerge, echo=FALSE,warning=FALSE,message=FALSE}
source("C:\Users\Kevin.Purcell\Documents\GitHub\EcosysMetricsGOM\Data\GatherSource\mergeDiversityData.R")
```




```{r regionalData, echo=FALSE,warning=FALSE,message=FALSE}
# Create seperate dataframes for Regions and seasons
sum.dat<-subset(complete.dat, complete.dat$month>=6&complete.dat$month<=8)
sum.la.dat<-subset(sum.dat, sum.dat$STAT_ZONE>=13&sum.dat$STAT_ZONE<=17)
sum.tx.dat<-subset(sum.dat, sum.dat$STAT_ZONE>=18&sum.dat$STAT_ZONE<=21)

fall.dat<-subset(complete.dat, complete.dat$month>=9&complete.dat$month<=11)
fall.la.dat<-subset(fall.dat, fall.dat$STAT_ZONE>=13&fall.dat$STAT_ZONE<=17)
fall.tx.dat<-subset(fall.dat, fall.dat$STAT_ZONE>=18&fall.dat$STAT_ZONE<=21)


## REFOMAT data.frames for diversity analysis
# Summer Louisiana Timeseries
sum.la.tab<-aggregate(ST_CNTEXP ~ YR + TAXONOMIC, data=sum.la.dat, FUN=sum)
sum.la.tab<-reshape(sum.la.tab, idvar="YR", timevar="TAXONOMIC", direction="wide")
sum.la.tab[is.na(sum.la.tab)]<-0
names(sum.la.tab) <- gsub("ST_CNTEXP.", "", names(sum.la.tab))  #removes the var name from reshape
YR<-sum.la.tab$YR
sum.la.tab$YR<-NULL

# Summer Texas Timeseries  
sum.tx.tab<-aggregate(ST_CNTEXP ~ YR + TAXONOMIC, data=sum.tx.dat, FUN=sum)
sum.tx.tab<-reshape(sum.tx.tab, idvar="YR", timevar="TAXONOMIC", direction="wide")
sum.tx.tab[is.na(sum.tx.tab)]<-0
names(sum.tx.tab) <- gsub("ST_CNTEXP.", "", names(sum.tx.tab))  #removes the var name from reshape
YR<-sum.tx.tab$YR
sum.tx.tab$YR<-NULL

# Fall Louisiana Timeseries
fall.la.tab<-aggregate(ST_CNTEXP ~ YR + TAXONOMIC, data=fall.la.dat, FUN=sum)
fall.la.tab<-reshape(fall.la.tab, idvar="YR", timevar="TAXONOMIC", direction="wide")
fall.la.tab[is.na(fall.la.tab)]<-0
names(fall.la.tab) <- gsub("ST_CNTEXP.", "", names(fall.la.tab))  #removes the var name from reshape
YR<-fall.la.tab$YR
fall.la.tab$YR<-NULL

# Fall Texas Timeseries  
fall.tx.tab<-aggregate(ST_CNTEXP ~ YR + TAXONOMIC, data=fall.tx.dat, FUN=sum)
fall.tx.tab<-reshape(fall.tx.tab, idvar="YR", timevar="TAXONOMIC", direction="wide")
fall.tx.tab[is.na(fall.tx.tab)]<-0
names(fall.tx.tab) <- gsub("ST_CNTEXP.", "", names(fall.tx.tab))  #removes the var name from reshape
YR<-fall.tx.tab$YR
fall.tx.tab$YR<-NULL
```

Data was then limited to the summer (```r min(sum.dat$month)``` - ```r max(sum.dat$month)```) and fall (```r min(fall.dat$month)``` - ```r max(fall.dat$month)```) months.  The nwGOM was divided into two regions Louisiana (```r min(fall.la.dat$STAT_ZONE)```- ```r max(fall.la..dat$STAT_ZONE)```) and Texas (```r min(fall.tx.dat$STAT_ZONE)```-```r max(fall.tx.dat$STAT_ZONE)```.  

A function ```divMetrics()``` was written to calcuate all the diversity metrics of interest for each of the region and seasonal data sets and returen a data frame of values.


```{r divData, echo=TRUE,warning=FALSE,message=FALSE}
# load diversity function
source("C:\\Users\\Kevin.Purcell\\Documents\\GitHub\\EcosysMetricsGOM\\functions\\divMetrics.R")

pri# calculate diversity metrics
sum.la.agg<-divMetrics(sum.la.tab)
sum.la.agg$mod<-"sum.la"

sum.tx.agg<-divMetrics(sum.tx.tab)
sum.tx.agg$mod<-"sum.tx"

fall.la.agg<-divMetrics(fall.la.tab)
fall.la.agg$mod<-"fall.la"

fall.tx.agg<-divMetrics(fall.tx.tab)
fall.tx.agg$mod<-"fall.tx"

# source("C:\\Users\\Kevin.Purcell\\Desktop\\EcosysMetricsGOM\\Analysis\\ResultsFigures\\LaDivMetricsFig.R")
# source("C:\\Users\\Kevin.Purcell\\Desktop\\EcosysMetricsGOM\\Analysis\\ResultsFigures\\TxDivMetricsFig.R")
# source("C:\\Users\\Kevin.Purcell\\Desktop\\EcosysMetricsGOM\\Analysis\\ResultsFigures\\LaDivSmoothFig.R")
# source("C:\\Users\\Kevin.Purcell\\Desktop\\EcosysMetricsGOM\\Analysis\\ResultsFigures\\TxDivSmoothFig.R")
```
Data frames were created for each of the region/seasonal data sets.


```{r lowessCalcs, echo=FALSE, message=FALSE, warning=FALSE} 
### Piecewise regression
# Create a df for each lowess smooth
sum.la.S<-lowess(sum.la.agg$S~sum.la.agg$YR); sum.la.S<-as.data.frame(sum.la.S)
sum.la.d<-lowess(sum.la.agg$d~sum.la.agg$YR)
sum.la.J<-lowess(sum.la.agg$J~sum.la.agg$YR)
sum.la.shan<-lowess(sum.la.agg$shan~sum.la.agg$YR)
sum.la.simp<-lowess(sum.la.agg$simp~sum.la.agg$YR)
sum.la.N1<-lowess(sum.la.agg$N1~sum.la.agg$YR)
sum.la.N2<-lowess(sum.la.agg$N2~sum.la.agg$YR)  
  
sum.tx.S<-lowess(sum.tx.agg$S~sum.tx.agg$YR)
sum.tx.d<-lowess(sum.tx.agg$d~sum.tx.agg$YR)
sum.tx.J<-lowess(sum.tx.agg$J~sum.tx.agg$YR)
sum.tx.shan<-lowess(sum.tx.agg$shan~sum.tx.agg$YR)
sum.tx.simp<-lowess(sum.tx.agg$simp~sum.tx.agg$YR)
sum.tx.N1<-lowess(sum.tx.agg$N1~sum.tx.agg$YR)
sum.tx.N2<-lowess(sum.tx.agg$N2~sum.tx.agg$YR)

fall.la.S<-lowess(fall.la.agg$S~fall.la.agg$YR)
fall.la.d<-lowess(fall.la.agg$d~fall.la.agg$YR)
fall.la.J<-lowess(fall.la.agg$J~fall.la.agg$YR)
fall.la.shan<-lowess(fall.la.agg$shan~fall.la.agg$YR)
fall.la.simp<-lowess(fall.la.agg$simp~fall.la.agg$YR)
fall.la.N1<-lowess(fall.la.agg$N1~fall.la.agg$YR)
fall.la.N2<-lowess(fall.la.agg$N2~fall.la.agg$YR)

fall.tx.S<-lowess(fall.tx.agg$S~fall.tx.agg$YR)
fall.tx.d<-lowess(fall.tx.agg$d~fall.tx.agg$YR)
fall.tx.J<-lowess(fall.tx.agg$J~fall.tx.agg$YR)
fall.tx.shan<-lowess(fall.tx.agg$shan~fall.tx.agg$YR)
fall.tx.simp<-lowess(fall.tx.agg$simp~fall.tx.agg$YR)
fall.tx.N1<-lowess(fall.tx.agg$N1~fall.tx.agg$YR)
fall.tx.N2<-lowess(fall.tx.agg$N2~fall.tx.agg$YR)
```











```{r fig1, echo=FALSE,warning=FALSE,message=FALSE, fig.align='center'}
####
####

names(shrcom.agg2)
shrcom.agg2<-aggregate(effort~ yr, data=shrcom.agg, FUN=sum)
shrcom.agg2<-subset(shrcom.agg2, shrcom.agg2$yr>=1987)

shrcom<-data.frame(shrcom.agg2$effort, shrcom.agg2$yr)
colnames(shrcom)[1]<-'y'
colnames(shrcom)[2]<-'x'

plot(shrcom$x,shrcom$y, pch=16)
shrcom.mod<-lm(shrcom$y~shrcom$x)
shrcom.seg.mod<-segmented(shrcom.mod, seg.Z=~x, psi=c(1985))
summary(shrcom.seg.mod)
plot(shrcom.seg.mod)

names(complete.dat)
biomass.dat<-aggregate(cpue~YR, data=complete.dat, FUN=mean)
abundance.dat<-aggregate(catch_cpue~YR, data=complete.dat, FUN=mean)

# source to figure 1 code
# 4 panel plot of Abundance-Biomass time-series and Hypoxia and Effort time-series
source("C:\Users\Kevin.Purcell\Documents\GitHub\EcosysMetricsGOM\Analysis\ResultsFigures\figure1.R")

```

```{r}
# load the break point function
source("C:\\Users\\Kevin.Purcell\\Documents\\GitHub\\EcosysMetricsGOM\\functions\\breakpts.R")
breakpt.fun(sum.la.agg,1,4) # summer LA J
breakpt.fun(sum.la.agg,1,5) # summer LA d
breakpt.fun(sum.la.agg,1,6)
breakpt.fun(sum.la.agg,1,7)
breakpt.fun(sum.la.agg,1,8)


breakpt.fun(biomass.dat,1,2)
breakpt.fun(abundance.dat,1,2)
breakpt.fun(shrcom.agg2,1,2)
breakpt.fun(hypox.area, 1,2)


#bind the model output tables
```



```{r}
#package methods

library(segmented)

lin.mod<-lm(y~x, data=sum.la.S)
segmented.mod<-segmented(lin.mod, seg.Z=~x, psi=1999)

plot(y ~ x, data=sum.la.S, pch=16) 
plot(segmented.mod$fitted.values~segmented.mod$coefficients)
```

## GAM Models

This might need to be a seperate analysis.  Also just found some citations to species time curves (```citep("10.1146/annurev.ecolsys.110308.120159","10.1890/05-0067","10.1046/j.1461-0248.2003.00497.x","10.1890/05-0067")``` which could be an interesting way to determine the stability of the ecosystem and if we are seeing changes before and after large distrubtions in the ecosystem.  Perhaps I should revisit the Lorenz Curves (univariate:Gini index) from (```citep("10.1139/f03-076")```) as a parameter but that uses catch, abundance, and distributional area so I am not sure that I can make the connections with the give resolution of data.  

Considering developing a set of GAM models to examine the relationship between hypoxia, effort and the specified diversity metrics.  

metric ~ s(year) + s(year, by=area.hypoxia) + s(year, by=fishing effort)


make a data set:


